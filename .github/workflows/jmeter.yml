name: Run JMeter Vault Tests

on:
  push:
    branches: [ main, PersonalVault ]
    paths:
      - 'Vaults/**.jmx'
      - 'data/**'
  workflow_dispatch:

jobs:
Â  run-vault-tests:
Â    runs-on: ubuntu-latest

Â    strategy:
Â      matrix:
Â        vault: [ 'DigitalVault', 'EOLVault', 'HealthVault', 'LegalVault', 'PersonalVault', 'Subscription' ]

Â    steps:

Â      - name: Checkout repository
Â        uses: actions/checkout@v4
Â        with:
Â          fetch-depth: 0

Â      - name: Set up Java (JMeter needs Java)
Â        uses: actions/setup-java@v4
Â        with:
Â          distribution: 'temurin'
Â          java-version: '17'

Â      - name: Install required tools
Â        run: |
Â          sudo apt-get update
Â          sudo apt-get install -y wget tar xmlstarlet

Â      - name: Download & extract JMeter
Â        run: |
Â          JMETER_VER="5.6.3"
Â          wget -q https://dlcdn.apache.org/jmeter/binaries/apache-jmeter-${JMETER_VER}.tgz
Â          tar xzf apache-jmeter-${JMETER_VER}.tgz

Â      - name: Prepare results folder
Â        run: mkdir -p results

Â      - name: Find latest JMX in the vault
Â        id: find_jmx
Â        run: |
Â          VAULT_DIR="Vaults/${{ matrix.vault }}"
Â          LATEST=$(ls -1t "${VAULT_DIR}"/*.jmx 2>/dev/null | head -n1 || true)
Â          if [ -n "$LATEST" ]; then
Â            echo "found=$LATEST" >> "$GITHUB_OUTPUT"
Â          else
Â            echo "found=" >> "$GITHUB_OUTPUT"
Â          fi

Â      - name: Show chosen JMX
Â        if: ${{ steps.find_jmx.outputs.found != '' }}
Â        run: echo "Running ${{ steps.find_jmx.outputs.found }}"

Â      # ---------------------------------------------------------
Â      # ðŸš€ FULLY UPGRADED RUN JMETER WITH NORMALIZATION + VALIDATION
Â      # ---------------------------------------------------------
Â      - name: Run JMeter
Â        if: ${{ steps.find_jmx.outputs.found != '' }}
Â        run: |
Â          set -e
Â          JMETER_HOME="apache-jmeter-5.6.3"
Â          JMX="${{ steps.find_jmx.outputs.found }}"
Â          RUN_ID="${{ matrix.vault }}-$(date +%Y%m%d-%H%M%S)"
Â          RUN_DIR="results/${RUN_ID}"

Â          mkdir -p "${RUN_DIR}"
Â          cp -r data "${RUN_DIR}/data"

Â          echo "Copied JMX:"
Â          cp "${JMX}" "${RUN_DIR}/testplan.jmx"

Â          echo "Normalizing JMX paths..."

Â          # Convert Windows backslashes -> /
Â          sed -i 's#\\\\#/#g' "${RUN_DIR}/testplan.jmx"

Â          # Remove drive letters like C:/ or D:/
Â          sed -i 's#[A-Za-z]:/##g' "${RUN_DIR}/testplan.jmx"

Â          # XML-safe normalization of CSV filename references
Â          for f in data/*; do
Â            name=$(basename "$f")
Â            xmlstarlet ed -L \
Â              -u "//stringProp[@name='filename' and contains(text(), '${name}')]" \
Â              -v "data/${name}" \
Â              "${RUN_DIR}/testplan.jmx" || true
Â          done

Â          echo "After XML normalization (filenames found):"
Â          xmlstarlet sel -t -m "//stringProp[@name='filename']" -v . -n "${RUN_DIR}/testplan.jmx" || true

Â          echo "Validating referenced CSV files exist..."

Â          # Validate that referenced CSVs exist before running JMeter
Â          ERR=0
Â          grep -oP '(?<=<stringProp name="filename">)[^<]+' "${RUN_DIR}/testplan.jmx" | while read file; do
Â            if [ ! -f "${RUN_DIR}/${file}" ]; then
Â              echo "âŒ ERROR: Missing CSV referenced in JMX: ${file}"
Â              ERR=1
Â            fi
Â          done

Â          if [ "$ERR" = "1" ]; then
Â            echo "Stopping because CSV references are incorrect."
Â            exit 1
Â          fi

Â          echo "CSV validation passed. Running JMeter."

Â          "${JMETER_HOME}/bin/jmeter" -n \
Â            -t "${RUN_DIR}/testplan.jmx" \
Â            -l "${RUN_DIR}/results.jtl" \
Â            -j "${RUN_DIR}/jmeter.log" \
Â            -e -o "${RUN_DIR}/html"

Â          echo "JMeter run completed."

Â      - name: Upload report
Â        if: ${{ steps.find_jmx.outputs.found != '' }}
Â        uses: actions/upload-artifact@v4
Â        with:
Â          name: jmeter-report-${{ matrix.vault }}
Â          path: results/${{ matrix.vault }}-*/

Â      - name: No JMX found
Â        if: ${{ steps.find_jmx.outputs.found == '' }}
Â        run: echo "Skipping vault ${{ matrix.vault }} (No JMX found)"

