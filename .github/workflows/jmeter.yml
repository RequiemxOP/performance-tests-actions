name: Run JMeter Vault Tests (Smart Trigger)

on:
  push:
    branches: [ main, PersonalVault ]
    paths:
      - 'Vaults/**.jmx'
      - 'data/**'
  workflow_dispatch:

jobs:

  # -----------------------------------------------------
  # 1) DETECT WHICH VAULTS CHANGED
  # -----------------------------------------------------
  detect-vaults:
    runs-on: ubuntu-latest
    outputs:
      vaults: ${{ steps.find.outputs.vaults }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Detect changed vaults
        id: find
        run: |
          CHANGED=$(git diff --name-only HEAD^ HEAD)

          echo "Changed files:"
          echo "$CHANGED"

          VAULTS=$(echo "$CHANGED" | grep "^Vaults/" | cut -d'/' -f2 | sort -u)

          if [ -z "$VAULTS" ]; then
            echo "vaults=" >> $GITHUB_OUTPUT
          else
            echo "vaults=$(echo $VAULTS)" >> $GITHUB_OUTPUT
          fi

      - name: Show detected vaults
        run: echo "Vaults affected: ${{ steps.find.outputs.vaults }}"


  # -----------------------------------------------------
  # 2) RUN JMETER ONLY FOR CHANGED VAULTS
  # -----------------------------------------------------
  run-vault-tests:
    needs: detect-vaults
    if: needs.detect-vaults.outputs.vaults != ''
    runs-on: ubuntu-latest

    strategy:
      matrix:
        vault: ${{ needs.detect-vaults.outputs.vaults.split(' ') }}

    steps:

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install required tools
        run: |
          sudo apt-get update
          sudo apt-get install -y wget tar xmlstarlet

      - name: Download & extract JMeter
        run: |
          JMETER_VER="5.6.3"
          wget -q https://dlcdn.apache.org/jmeter/binaries/apache-jmeter-${JMETER_VER}.tgz
          tar xzf apache-jmeter-${JMETER_VER}.tgz

      - name: Find latest JMX inside vault
        id: find_jmx
        run: |
          VAULT_DIR="Vaults/${{ matrix.vault }}"
          LATEST=$(ls -1t "${VAULT_DIR}"/*.jmx 2>/dev/null | head -n1 || true)

          echo "found=$LATEST" >> $GITHUB_OUTPUT

      - name: Show chosen JMX
        if: ${{ steps.find_jmx.outputs.found != '' }}
        run: echo "Running ${{ steps.find_jmx.outputs.found }}"

      # ---------------------------------------------------------
      # ðŸš€ FULL RUN: NORMALIZE + CHECK CSVs + EXECUTE + SAVE
      # ---------------------------------------------------------
      - name: Run JMeter
        if: ${{ steps.find_jmx.outputs.found != '' }}
        run: |
          set -e
          JMETER_HOME="apache-jmeter-5.6.3"
          VAULT="Vaults/${{ matrix.vault }}"
          JMX="${{ steps.find_jmx.outputs.found }}"
          RUN_ID=$(date +%Y%m%d-%H%M%S)

          RUN_DIR="${VAULT}/Results/${RUN_ID}"
          mkdir -p "${RUN_DIR}"
          cp -r data "${RUN_DIR}/data"
          cp "${JMX}" "${RUN_DIR}/testplan.jmx"

          echo "Normalizing paths in testplan..."

          # Replace Windows paths
          sed -i 's#\\\\#/#g' "${RUN_DIR}/testplan.jmx"
          sed -i 's#[A-Za-z]:/##g' "${RUN_DIR}/testplan.jmx"

          # Normalize filename XML references
          for f in data/*; do
            name=$(basename "$f")
            xmlstarlet ed -L \
              -u "//stringProp[@name='filename' and contains(text(), '${name}')]" \
              -v "data/${name}" \
              "${RUN_DIR}/testplan.jmx" || true
          done

          echo "After normalizing CSV references:"
          xmlstarlet sel -t -m "//stringProp[@name='filename']" -v . -n "${RUN_DIR}/testplan.jmx" || true

          echo "Validating referenced CSV files..."
          ERR=0

          grep -oP '(?<=<stringProp name="filename">)[^<]+' "${RUN_DIR}/testplan.jmx" | while read file; do
            if [ ! -f "${RUN_DIR}/${file}" ]; then
              echo "âŒ Missing CSV: ${file}"
              ERR=1
            fi
          done

          if [ "$ERR" = "1" ]; then
            echo "Stopping workflow, CSV missing."
            exit 1
          fi

          echo "CSV validation OK. Running JMeter..."

          "$JMETER_HOME/bin/jmeter" -n \
            -t "${RUN_DIR}/testplan.jmx" \
            -l "${RUN_DIR}/results.jtl" \
            -j "${RUN_DIR}/jmeter.log" \
            -e -o "${RUN_DIR}/html"

          echo "JMeter execution completed."

      - name: Upload HTML report artifact
        if: ${{ steps.find_jmx.outputs.found != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: jmeter-report-${{ matrix.vault }}
          path: Vaults/${{ matrix.vault }}/Results/*

      - name: Commit results back to repo
        if: ${{ steps.find_jmx.outputs.found != '' }}
        run: |
          git config user.email "actions@github.com"
          git config user.name "GitHub Actions"

          git add Vaults/${{ matrix.vault }}/Results/*
          git commit -m "Add JMeter results for ${{ matrix.vault }} on $(date)"
          git push || true


  # -----------------------------------------------------
  # 3) If no vaults changed, show message
  # -----------------------------------------------------
  no-vaults:
    needs: detect-vaults
    if: needs.detect-vaults.outputs.vaults == ''
    runs-on: ubuntu-latest
    steps:
      - run: echo "No vaults changed â€” skipping run."
